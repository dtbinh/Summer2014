function [xp,Pp] = ekf_update_ranging_and_imu_17(xhat,uk,Pk,Rk,ytilde)
% function [xp,Pp] = ekf_update_ranging_and_imu(xhat,Pk,Rk,ytilde)
%
%xk: 17 x 2N+1, inertial position, inertial velocity, inertial quaternion, relative position, and relative quaternion ... then unknown feature parameters 
%
%uk[wi;wj;ai;aj;r(1,2,3)j/j] : 21 x 2N+1

n = length(xhat);

% body-frame vectors to localizers
rkj_j = reshape(uk(13:21),3,3);
rk1 = uk(13:15);
rk11 = uk(13);
rk12 = uk(14);
rk13 = uk(15);
rk2 = uk(16:18);
rk21 = uk(16);
rk22 = uk(17);
rk23 = uk(18);
rk3 = uk(19:21);
rk31 = uk(19);
rk32 = uk(20);
rk33 = uk(21);

% linearized state influence on measurement
H = zeros(6,n);
% expectation vector
yk = zeros(6,1);

% his position relative to mine. My body frame
rji = xhat(8:10);
rji1 = xhat(8);
rji2 = xhat(9);
rji3 = xhat(10);
% my attitude
qin = xhat(4:7);
% his attitude relative to mine. His body frame
qji = xhat(11:14);
qji1 = xhat(11);
qji2 = xhat(12);
qji3 = xhat(13);
qji4 = xhat(14);

Cji = attparsilent(qji,[6 1]);

%% expectation

rka_b = (repmat(rji,1,3)+Cji'*[rk1 rk2 rk3]);% vector from b origin to each marker on a

yk(1:9) = sqrt(sum((repmat(rka_b,1,3)-rkj_j(:,sort(repmat(1:3,1,3)))).^2,1))';
yk(10:18) = yk([1 4 7 2 5 8 3 6 9]);
%yk(4:6) = sqrt(sum ((repmat(rji,1,3) - [rk1 rk2 rk3]).^2,1) )';
%% build matrix 'H'
H(1:9,8:10) = [[ (2*rji1 - 2*rk11 + 2*rk11 - 2*rk12*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk13*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk12 + 2*rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk11*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk13*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk13 + 2*rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk11*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk12*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*rji1 - 2*rk11 + 2*rk21 - 2*rk22*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk23*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk12 + 2*rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk21*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk23*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk13 + 2*rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk21*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk22*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*rji1 - 2*rk11 + 2*rk31 - 2*rk32*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk33*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk12 + 2*rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk31*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk33*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk13 + 2*rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk31*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk32*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*rji1 - 2*rk21 + 2*rk11 - 2*rk12*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk13*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk22 + 2*rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk11*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk13*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk23 + 2*rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk11*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk12*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*rji1 - 2*rk21 + 2*rk21 - 2*rk22*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk23*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk22 + 2*rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk21*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk23*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk23 + 2*rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk21*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk22*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*rji1 - 2*rk21 + 2*rk31 - 2*rk32*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk33*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk22 + 2*rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk31*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk33*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk23 + 2*rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk31*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk32*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*rji1 - 2*rk31 + 2*rk11 - 2*rk12*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk13*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk32 + 2*rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk11*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk13*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk33 + 2*rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk11*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk12*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*rji1 - 2*rk31 + 2*rk21 - 2*rk22*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk23*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk32 + 2*rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk21*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk23*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk33 + 2*rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk21*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk22*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*rji1 - 2*rk31 + 2*rk31 - 2*rk32*(2*qji1*qji4 - 2*qji2*qji3) + 2*rk33*(2*qji1*qji3 + 2*qji2*qji4))/(2*((rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji2 - 2*rk32 + 2*rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + 2*rk31*(2*qji1*qji4 + 2*qji2*qji3) - 2*rk33*(2*qji1*qji2 - 2*qji3*qji4))/(2*((rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*rji3 - 2*rk33 + 2*rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - 2*rk31*(2*qji1*qji3 - 2*qji2*qji4) + 2*rk32*(2*qji1*qji2 + 2*qji3*qji4))/(2*((rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]];
H(1:9,11:14) = [[ (2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk11 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk12 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk13 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk21 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk22 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk23 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk13 + 2*qji2*rk12 - 2*qji3*rk11)*(rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk11 + 2*qji3*rk13 - 2*qji4*rk12)*(rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk12 - 2*qji2*rk13 + 2*qji4*rk11)*(rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk11 + 2*qji3*rk12 + 2*qji4*rk13)*(rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk11 - rk12*(2*qji1*qji4 - 2*qji2*qji3) + rk13*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk12*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk11*(2*qji1*qji4 + 2*qji2*qji3) - rk13*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk13*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk11*(2*qji1*qji3 - 2*qji2*qji4) + rk12*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk23 + 2*qji2*rk22 - 2*qji3*rk21)*(rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk21 + 2*qji3*rk23 - 2*qji4*rk22)*(rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk22 - 2*qji2*rk23 + 2*qji4*rk21)*(rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk21 + 2*qji3*rk22 + 2*qji4*rk23)*(rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk21 - rk22*(2*qji1*qji4 - 2*qji2*qji3) + rk23*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk22*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk21*(2*qji1*qji4 + 2*qji2*qji3) - rk23*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk23*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk21*(2*qji1*qji3 - 2*qji2*qji4) + rk22*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]
[ (2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) - 2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) + 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk33 + 2*qji2*rk32 - 2*qji3*rk31)*(rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2)), (2*(2*qji1*rk31 + 2*qji3*rk33 - 2*qji4*rk32)*(rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4)) - 2*(2*qji1*rk32 - 2*qji2*rk33 + 2*qji4*rk31)*(rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4)) + 2*(2*qji2*rk31 + 2*qji3*rk32 + 2*qji4*rk33)*(rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4)))/(2*((rji1 - rk31 + rk31 - rk32*(2*qji1*qji4 - 2*qji2*qji3) + rk33*(2*qji1*qji3 + 2*qji2*qji4))^2 + (rji2 - rk32 + rk32*(qji1^2 - qji2^2 + qji3^2 - qji4^2) + rk31*(2*qji1*qji4 + 2*qji2*qji3) - rk33*(2*qji1*qji2 - 2*qji3*qji4))^2 + (rji3 - rk33 + rk33*(qji1^2 - qji2^2 - qji3^2 + qji4^2) - rk31*(2*qji1*qji3 - 2*qji2*qji4) + rk32*(2*qji1*qji2 + 2*qji3*qji4))^2)^(1/2))]];

H(10:18,8:14) = H([1 4 7 2 5 8 3 6 9],8:14);
%% kalman gain
Kk = Pk*H'*((H*Pk*H'+Rk)\eye(18));

xp = xhat + Kk*(ytilde-yk);
Pp = (eye(n)-Kk*H)*Pk;

% normalize quaternions
xp(11:14) = xp(11:14)/norm(xp(11:14));
xp(4:7) = xp(4:7)/norm(xp(4:7));
end