<pre class="code">
<span class="srcline"><span class="lineno"><a href="123,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T70U3">yk</span> = measurement_eq_10_state(<span class="var type1" id="S3T67U6">xk</span>,<span class="var type1" id="S4T73U7">nk</span>,<span class="var type1" id="S5T4U8">uk</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="123,2" id="srcline2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="123,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% m1: # of features agent 1 sees</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="123,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%xk: 10 x 2N+1, inertial position, inertial velocity, inertial quaternion, relative position, and relative quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%nk: 3*m1 x 2N+1, feature range/bearing/azimuth errors FOR EACH FEATURE</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,7" id="srcline7"> 7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="123,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">%uk[wi;ai;# of i features;rkn;<span class="keyword">...</span><span class="comment">;# of j features;rkn;...] : 6+2+3*m x 2N+1, m being total # of features from i and j </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="123,9" id="srcline9"> 9</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="123,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo" id="T3:U5"><span class="var type1" id="S6T3U11">m1</span> = <span class="mxinfo" id="T3:U7"><span class="var type1" id="S5T4U13">uk</span>(<span class="mxinfo" id="T3:U9">7</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo" id="T3:U10"><span class="var type1" id="S7T3U17">m</span> = <span class="var type1" id="S6T3U18">m1</span></span>;<span class="comment">% total # of features</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,12" id="srcline12">12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="123,13" id="srcline13">13</a></span><span class="line"><span class="comment">% 3 x m1 array of known inertial position of features seen by agent 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,14" id="srcline14">14</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T8:U13"><span class="var type1" id="S6T3U22">m1</span> &gt; <span class="mxinfo" id="T3:U15">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="123,15" id="srcline15">15</a></span><span class="line">    <span class="mxinfo" id="T74:U16"><span class="var type1" id="S8T74U26">RKN_1</span> = <span class="mxinfo" id="T92:U18"><span class="mxinfo" id="T75:U19">reshape(<span class="mxinfo" id="T2:U20"><span class="var type1" id="S5T4U31">uk</span>(<span class="mxinfo" id="T17:U22"><span class="mxinfo" id="T3:U23">7</span>+(<span class="mxinfo" id="T17:U24">1:<span class="mxinfo" id="T3:U25"><span class="var type1" id="S6T3U38">m1</span>*<span class="mxinfo" id="T3:U27">3</span></span></span>)</span>)</span>,3,[])</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,16" id="srcline16">16</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,17" id="srcline17">17</a></span><span class="line">    <span class="mxinfo" id="T74:U28"><span class="var type1" id="S8T74U46">RKN_1</span> = <span class="mxinfo" id="T29:U30">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,18" id="srcline18">18</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,19" id="srcline19">19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="123,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo" id="T3:U31"><span class="var type1" id="S10T3U51">n</span> = <span class="mxinfo" id="T3:U33">size(<span class="var type1" id="S3T67U54">xk</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo" id="T3:U35"><span class="var type1" id="S12T3U58">l</span> = <span class="mxinfo" id="T3:U37">size(<span class="var type1" id="S4T73U61">nk</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="123,23" id="srcline23">23</a></span><span class="line"><span class="mxinfo" id="T70:U39"><span class="var type1" id="S2T70U65">yk</span> = <span class="mxinfo" id="T70:U41">zeros(<span class="mxinfo" id="T3:U42"><span class="mxinfo" id="T3:U43">3</span>*<span class="var type1" id="S7T3U70">m</span></span>,<span class="mxinfo" id="T3:U45">size(<span class="var type1" id="S3T67U73">xk</span>,2)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,24" id="srcline24">24</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S14T3U77">k</span> = <span class="mxinfo" id="T3:U48">1</span>:<span class="mxinfo" id="T3:U49">size(<span class="var type1" id="S3T67U82">xk</span>,2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,25" id="srcline25">25</a></span><span class="line">    <span class="comment">% estimated my inertial position</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,26" id="srcline26">26</a></span><span class="line">    <span class="mxinfo" id="T32:U51"><span class="var type1" id="S15T32U86">rin</span> = <span class="mxinfo" id="T32:U53"><span class="var type1" id="S3T67U88">xk</span>(<span class="mxinfo" id="T48:U55"><span class="mxinfo" id="T3:U56">1</span>:<span class="mxinfo" id="T3:U57">3</span></span>,<span class="var type1" id="S14T3U92">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,27" id="srcline27">27</a></span><span class="line">    <span class="comment">% my estimated inertial attitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,28" id="srcline28">28</a></span><span class="line">    <span class="mxinfo" id="T42:U59"><span class="var type1" id="S16T42U95">qin</span> = <span class="mxinfo" id="T42:U61"><span class="var type1" id="S3T67U97">xk</span>(<span class="mxinfo" id="T79:U63"><span class="mxinfo" id="T3:U64">7</span>:<span class="mxinfo" id="T3:U65">10</span></span>,<span class="var type1" id="S14T3U101">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,29" id="srcline29">29</a></span><span class="line">    <span class="mxinfo" id="T43:U67"><span class="var type1" id="S17T43U104">Cin</span> = <span class="mxinfo" id="T43:U69"><span class="fcn" id="F352N2:B106">attparsilentmex</span>(<span class="var type1" id="S16T42U107">qin</span>,[6 1])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,30" id="srcline30">30</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="123,31" id="srcline31">31</a></span><span class="line">    <span class="comment">% feature measurements</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,32" id="srcline32">32</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S19T3U114">kk</span> = <span class="mxinfo" id="T3:U72">1</span>:<span class="var type1" id="S6T3U117">m1</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,33" id="srcline33">33</a></span><span class="line">        <span class="comment">% get the i frame vector to the feature</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,34" id="srcline34">34</a></span><span class="line">        <span class="mxinfo" id="T32:U74"><span class="var type1" id="S20T32U120">rki</span> = <span class="mxinfo" id="T32:U76"><span class="var type1" id="S17T43U122">Cin</span>*(<span class="mxinfo" id="T32:U78"><span class="mxinfo" id="T93:U79"><span class="mxinfo" id="T94:U80"><span class="var type1" id="S8T74U127">RKN_1</span>(<span class="var type1" id="S19T3U128">kk</span>,:)</span>'</span> - <span class="var type1" id="S15T32U130">rin</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,35" id="srcline35">35</a></span><span class="line">        <span class="comment">% the index for now</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,36" id="srcline36">36</a></span><span class="line">        <span class="mxinfo" id="T48:U84"><span class="var type1" id="S21T48U133">index</span> = <span class="mxinfo" id="T48:U86"><span class="mxinfo" id="T3:U87">(<span class="mxinfo" id="T3:U88"><span class="var type1" id="S19T3U138">kk</span>-<span class="mxinfo" id="T3:U90">1</span></span>)*<span class="mxinfo" id="T3:U91">3</span></span> + (<span class="mxinfo" id="T48:U92">1:3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,37" id="srcline37">37</a></span><span class="line">        <span class="comment">% compute range/bearing/declination</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,38" id="srcline38">38</a></span><span class="line">        <span class="comment">%y_kk = [sqrt(sum(rki.^2));atan2(rki(2),rki(1));atan2(rki(3),sqrt(sum(rki(1:2).^2)))] + nk(index,k);</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,39" id="srcline39">39</a></span><span class="line">        <span class="mxinfo" id="T32:U93"><span class="var type1" id="S22T32U147">y_kk</span> = <span class="mxinfo" id="T32:U95"><span class="fcn" id="F490N14:B149">vector2polar</span>(<span class="var type1" id="S20T32U150">rki</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,40" id="srcline40">40</a></span><span class="line">        <span class="mxinfo" id="T32:U97"><span class="mxinfo" id="T32:U98"><span class="var type1" id="S2T70U154">yk</span>(<span class="var type1" id="S21T48U155">index</span>,<span class="var type1" id="S14T3U156">k</span>)</span> = <span class="var type1" id="S22T32U157">y_kk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,41" id="srcline41">41</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,42" id="srcline42">42</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="123,43" id="srcline43">43</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T8:U103"><span class="var type1" id="S14T3U161">k</span> &gt; <span class="mxinfo" id="T3:U105">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="123,44" id="srcline44">44</a></span><span class="line">        <span class="comment">% minimize all angle differences</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,45" id="srcline45">45</a></span><span class="line">        <span class="mxinfo" id="T2:U106"><span class="mxinfo" id="T2:U107"><span class="var type1" id="S2T70U166">yk</span>( (<span class="mxinfo" id="T8:U109"><span class="mxinfo" id="T3:U110">2</span>:<span class="mxinfo" id="T3:U111">3</span>:<span class="mxinfo" id="T3:U112"><span class="mxinfo" id="T3:U113">3</span>*<span class="var type1" id="S6T3U174">m1</span></span></span>),<span class="var type1" id="S14T3U175">k</span> )</span> = <span class="mxinfo" id="T2:U116"><span class="fcn" id="F513N9:B177">minangle</span>(<span class="mxinfo" id="T2:U117"><span class="var type1" id="S2T70U179">yk</span>((<span class="mxinfo" id="T8:U119"><span class="mxinfo" id="T3:U120">2</span>:<span class="mxinfo" id="T3:U121">3</span>:<span class="mxinfo" id="T3:U122"><span class="mxinfo" id="T3:U123">3</span>*<span class="var type1" id="S6T3U187">m1</span></span></span>),<span class="var type1" id="S14T3U188">k</span>)</span>,<span class="mxinfo" id="T2:U126"><span class="var type1" id="S2T70U190">yk</span>((<span class="mxinfo" id="T8:U128"><span class="mxinfo" id="T3:U129">2</span>:<span class="mxinfo" id="T3:U130">3</span>:<span class="mxinfo" id="T3:U131"><span class="mxinfo" id="T3:U132">3</span>*<span class="var type1" id="S6T3U198">m1</span></span></span>),<span class="mxinfo" id="T3:U134">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,46" id="srcline46">46</a></span><span class="line">        <span class="mxinfo" id="T2:U135"><span class="mxinfo" id="T2:U136"><span class="var type1" id="S2T70U203">yk</span>( (<span class="mxinfo" id="T8:U138"><span class="mxinfo" id="T3:U139">3</span>:<span class="mxinfo" id="T3:U140">3</span>:<span class="mxinfo" id="T3:U141"><span class="mxinfo" id="T3:U142">3</span>*<span class="var type1" id="S6T3U211">m1</span></span></span>),<span class="var type1" id="S14T3U212">k</span> )</span> = <span class="mxinfo" id="T2:U145"><span class="fcn" id="F513N9:B214">minangle</span>(<span class="mxinfo" id="T2:U146"><span class="var type1" id="S2T70U216">yk</span>((<span class="mxinfo" id="T8:U148"><span class="mxinfo" id="T3:U149">3</span>:<span class="mxinfo" id="T3:U150">3</span>:<span class="mxinfo" id="T3:U151"><span class="mxinfo" id="T3:U152">3</span>*<span class="var type1" id="S6T3U224">m1</span></span></span>),<span class="var type1" id="S14T3U225">k</span>)</span>,<span class="mxinfo" id="T2:U155"><span class="var type1" id="S2T70U227">yk</span>((<span class="mxinfo" id="T8:U157"><span class="mxinfo" id="T3:U158">3</span>:<span class="mxinfo" id="T3:U159">3</span>:<span class="mxinfo" id="T3:U160"><span class="mxinfo" id="T3:U161">3</span>*<span class="var type1" id="S6T3U235">m1</span></span></span>),<span class="mxinfo" id="T3:U163">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="123,47" id="srcline47">47</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,48" id="srcline48">48</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="123,49" id="srcline49">49</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="123,50" id="srcline50">50</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
