<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T43U3">yk</span> = measurement_eq_17_state(<span class="var type1" id="S3T23U6">xk</span>,<span class="var type1" id="S4T24U7">nk</span>,<span class="var type1" id="S5T1U8">uk</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% m1: # of features agent 1 sees</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% m2: # of features agent 2 sees</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%xk: 17 x 2N+1, inertial position, inertial velocity, inertial quaternion, relative position, and relative quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">%nk: 12+3*m1+3*m2 x 2N+1, error on range/bearing/azimuth for agent 1, then agent 2, then magnetometer errors for agent 1 then 2, </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">%       THEN feature range/bearing/azimuth errors FOR EACH FEATURE for agent 1, then same for agent 2 </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="comment">%uk[wi;ai;mag_i;# of i features;rkn;<span class="keyword">...</span><span class="comment">;# of j features;rkn;...] : 9+2+3*m x 2N+1, m being total # of features from i and j </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"><span class="mxinfo" id="T27:U5"><span class="var type1" id="S6T27U11">mag_i</span> = <span class="mxinfo" id="T27:U7"><span class="var type1" id="S5T1U13">uk</span>(<span class="mxinfo" id="T34:U9"><span class="mxinfo" id="T2:U10">7</span>:<span class="mxinfo" id="T2:U11">9</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"><span class="mxinfo" id="T2:U12"><span class="var type1" id="S7T2U19">m1</span> = <span class="mxinfo" id="T2:U14"><span class="var type1" id="S5T1U21">uk</span>(<span class="mxinfo" id="T2:U16">10</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="mxinfo" id="T2:U17"><span class="var type1" id="S8T2U25">m2</span> = <span class="mxinfo" id="T2:U19"><span class="var type1" id="S5T1U27">uk</span>(<span class="mxinfo" id="T2:U21"><span class="mxinfo" id="T2:U22"><span class="mxinfo" id="T2:U23">10</span>+<span class="mxinfo" id="T2:U24"><span class="mxinfo" id="T2:U25">3</span>*<span class="var type1" id="S7T2U33">m1</span></span></span>+<span class="mxinfo" id="T2:U27">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"><span class="mxinfo" id="T2:U28"><span class="var type1" id="S9T2U37">m</span> = <span class="mxinfo" id="T2:U30"><span class="var type1" id="S7T2U39">m1</span>+<span class="var type1" id="S8T2U40">m2</span></span></span>;<span class="comment">% total # of features</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="comment">% 3 x m1 array of known inertial position of features seen by agent 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo" id="T42:U33"><span class="var type1" id="S10T42U43">RKN_1</span> = <span class="mxinfo" id="T42:U35"><span class="mxinfo" id="T44:U36">reshape(<span class="mxinfo" id="T11:U37"><span class="var type1" id="S5T1U48">uk</span>(<span class="mxinfo" id="T10:U39"><span class="mxinfo" id="T2:U40">10</span>+(<span class="mxinfo" id="T10:U41">1:<span class="mxinfo" id="T2:U42"><span class="var type1" id="S7T2U55">m1</span>*<span class="mxinfo" id="T2:U44">3</span></span></span>)</span>)</span>,3,[])</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"><span class="comment">% 3 x m2 array of known inertial position of features seen by agent 2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo" id="T42:U45"><span class="var type1" id="S12T42U62">RKN_2</span> = <span class="mxinfo" id="T42:U47"><span class="mxinfo" id="T44:U48">reshape(<span class="mxinfo" id="T11:U49"><span class="var type1" id="S5T1U67">uk</span>(<span class="mxinfo" id="T10:U51"><span class="mxinfo" id="T2:U52"><span class="mxinfo" id="T2:U53">10</span>+<span class="mxinfo" id="T2:U54"><span class="mxinfo" id="T2:U55">3</span>*<span class="var type1" id="S7T2U73">m1</span></span></span>+(<span class="mxinfo" id="T10:U57">1:<span class="mxinfo" id="T2:U58"><span class="mxinfo" id="T2:U59">3</span>*<span class="var type1" id="S8T2U79">m2</span></span></span>)</span>)</span>,3,[])</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"><span class="mxinfo" id="T2:U61"><span class="var type1" id="S13T2U85">n</span> = <span class="mxinfo" id="T2:U63">size(<span class="var type1" id="S3T23U88">xk</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"><span class="mxinfo" id="T2:U65"><span class="var type1" id="S15T2U92">l</span> = <span class="mxinfo" id="T2:U67">size(<span class="var type1" id="S4T24U95">nk</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"><span class="mxinfo" id="T43:U69"><span class="var type1" id="S2T43U99">yk</span> = <span class="mxinfo" id="T43:U71">zeros(<span class="mxinfo" id="T2:U72"><span class="mxinfo" id="T2:U73">9</span>+<span class="mxinfo" id="T2:U74"><span class="mxinfo" id="T2:U75">3</span>*<span class="var type1" id="S9T2U106">m</span></span></span>,<span class="mxinfo" id="T2:U77">size(<span class="var type1" id="S3T23U109">xk</span>,2)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S17T2U113">k</span> = <span class="mxinfo" id="T2:U80">1</span>:<span class="mxinfo" id="T2:U81">size(<span class="var type1" id="S3T23U118">xk</span>,2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">    <span class="comment">% i to j frame transform</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">    <span class="mxinfo" id="T25:U83"><span class="var type1" id="S18T25U122">qhat</span> = <span class="mxinfo" id="T25:U85"><span class="var type1" id="S3T23U124">xk</span>(<span class="mxinfo" id="T49:U87"><span class="mxinfo" id="T2:U88">14</span>:<span class="mxinfo" id="T2:U89">17</span></span>,<span class="var type1" id="S17T2U128">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">    <span class="comment">% est relative position</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">    <span class="mxinfo" id="T27:U91"><span class="var type1" id="S19T27U131">rji_i_hat</span> = <span class="mxinfo" id="T27:U93"><span class="var type1" id="S3T23U133">xk</span>(<span class="mxinfo" id="T34:U95"><span class="mxinfo" id="T2:U96">11</span>:<span class="mxinfo" id="T2:U97">13</span></span>,<span class="var type1" id="S17T2U137">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">    <span class="comment">% estimated my inertial position</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">    <span class="mxinfo" id="T27:U99"><span class="var type1" id="S20T27U140">rin</span> = <span class="mxinfo" id="T27:U101"><span class="var type1" id="S3T23U142">xk</span>(<span class="mxinfo" id="T34:U103"><span class="mxinfo" id="T2:U104">1</span>:<span class="mxinfo" id="T2:U105">3</span></span>,<span class="var type1" id="S17T2U146">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">    <span class="comment">% my estimated inertial attitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">    <span class="mxinfo" id="T25:U107"><span class="var type1" id="S21T25U149">qin</span> = <span class="mxinfo" id="T25:U109"><span class="var type1" id="S3T23U151">xk</span>(<span class="mxinfo" id="T49:U111"><span class="mxinfo" id="T2:U112">7</span>:<span class="mxinfo" id="T2:U113">10</span></span>,<span class="var type1" id="S17T2U155">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">    <span class="mxinfo" id="T26:U115"><span class="var type1" id="S22T26U158">Cin</span> = <span class="mxinfo" id="T26:U117"><span class="fcn" id="F115N2:B160">attparsilentmex</span>(<span class="var type1" id="S21T25U161">qin</span>,[6 1])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">    <span class="mxinfo" id="T26:U119"><span class="var type1" id="S24T26U168">Cji</span> = <span class="mxinfo" id="T26:U121"><span class="fcn" id="F115N2:B170">attparsilentmex</span>(<span class="var type1" id="S18T25U171">qhat</span>,[6 1])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">    <span class="comment">% expected range/bearing/azimuth from agent i's measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">    <span class="mxinfo" id="T27:U123"><span class="mxinfo" id="T27:U124"><span class="var type1" id="S2T43U179">yk</span>(<span class="mxinfo" id="T34:U126"><span class="mxinfo" id="T2:U127">1</span>:<span class="mxinfo" id="T2:U128">3</span></span>,<span class="var type1" id="S17T2U183">k</span>)</span> = <span class="mxinfo" id="T27:U130"><span class="mxinfo" id="T27:U131">[<span class="mxinfo" id="T2:U132">sqrt(<span class="mxinfo" id="T2:U133">sum(<span class="mxinfo" id="T27:U134"><span class="var type1" id="S19T27U192">rji_i_hat</span>.^2</span>)</span>)</span>;<span class="mxinfo" id="T2:U136">atan2(<span class="mxinfo" id="T2:U137"><span class="var type1" id="S19T27U198">rji_i_hat</span>(<span class="mxinfo" id="T2:U139">2</span>)</span>,<span class="mxinfo" id="T2:U140"><span class="var type1" id="S19T27U201">rji_i_hat</span>(<span class="mxinfo" id="T2:U142">1</span>)</span>)</span>;<span class="mxinfo" id="T2:U143">atan2(<span class="mxinfo" id="T2:U144"><span class="var type1" id="S19T27U207">rji_i_hat</span>(<span class="mxinfo" id="T2:U146">3</span>)</span>,<span class="mxinfo" id="T2:U147">sqrt(<span class="mxinfo" id="T2:U148">sum(<span class="mxinfo" id="T31:U149"><span class="mxinfo" id="T31:U150"><span class="var type1" id="S19T27U215">rji_i_hat</span>(<span class="mxinfo" id="T15:U152"><span class="mxinfo" id="T2:U153">1</span>:<span class="mxinfo" id="T2:U154">2</span></span>)</span>.^2</span>)</span>)</span>)</span>]</span> + <span class="mxinfo" id="T27:U155"><span class="var type1" id="S4T24U221">nk</span>(<span class="mxinfo" id="T34:U157"><span class="mxinfo" id="T2:U158">1</span>:<span class="mxinfo" id="T2:U159">3</span></span>,<span class="var type1" id="S17T2U225">k</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">    <span class="comment">% expectated relative vector from agent j's measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line">    <span class="mxinfo" id="T27:U161"><span class="var type1" id="S28T27U228">rij_j_hat</span> = <span class="mxinfo" id="T27:U163"><span class="mxinfo" id="T26:U164">-<span class="var type1" id="S24T26U231">Cji</span></span>*<span class="var type1" id="S19T27U232">rji_i_hat</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">    <span class="comment">% expected range/bearing/azimuth from agent j's measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line">    <span class="mxinfo" id="T27:U167"><span class="mxinfo" id="T27:U168"><span class="var type1" id="S2T43U236">yk</span>(<span class="mxinfo" id="T34:U170"><span class="mxinfo" id="T2:U171">4</span>:<span class="mxinfo" id="T2:U172">6</span></span>,<span class="var type1" id="S17T2U240">k</span>)</span> = <span class="mxinfo" id="T27:U174"><span class="mxinfo" id="T27:U175">[<span class="mxinfo" id="T2:U176">sqrt(<span class="mxinfo" id="T2:U177">sum(<span class="mxinfo" id="T27:U178"><span class="var type1" id="S28T27U249">rij_j_hat</span>.^2</span>)</span>)</span>;<span class="mxinfo" id="T2:U180">atan2(<span class="mxinfo" id="T2:U181"><span class="var type1" id="S28T27U255">rij_j_hat</span>(<span class="mxinfo" id="T2:U183">2</span>)</span>,<span class="mxinfo" id="T2:U184"><span class="var type1" id="S28T27U258">rij_j_hat</span>(<span class="mxinfo" id="T2:U186">1</span>)</span>)</span>;<span class="mxinfo" id="T2:U187">atan2(<span class="mxinfo" id="T2:U188"><span class="var type1" id="S28T27U264">rij_j_hat</span>(<span class="mxinfo" id="T2:U190">3</span>)</span>,<span class="mxinfo" id="T2:U191">sqrt(<span class="mxinfo" id="T2:U192">sum(<span class="mxinfo" id="T31:U193"><span class="mxinfo" id="T31:U194"><span class="var type1" id="S28T27U272">rij_j_hat</span>(<span class="mxinfo" id="T15:U196"><span class="mxinfo" id="T2:U197">1</span>:<span class="mxinfo" id="T2:U198">2</span></span>)</span>.^2</span>)</span>)</span>)</span>]</span> + <span class="mxinfo" id="T27:U199"><span class="var type1" id="S4T24U278">nk</span>(<span class="mxinfo" id="T34:U201"><span class="mxinfo" id="T2:U202">4</span>:<span class="mxinfo" id="T2:U203">6</span></span>,<span class="var type1" id="S17T2U282">k</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line">    <span class="comment">% expected magnetometer measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line">    <span class="mxinfo" id="T27:U205"><span class="mxinfo" id="T27:U206"><span class="var type1" id="S2T43U286">yk</span>(<span class="mxinfo" id="T34:U208"><span class="mxinfo" id="T2:U209">7</span>:<span class="mxinfo" id="T2:U210">9</span></span>,<span class="var type1" id="S17T2U290">k</span>)</span> = <span class="mxinfo" id="T27:U212"><span class="mxinfo" id="T27:U213"><span class="var type1" id="S24T26U293">Cji</span>*(<span class="mxinfo" id="T27:U215"><span class="var type1" id="S6T27U296">mag_i</span> + <span class="mxinfo" id="T27:U217"><span class="var type1" id="S4T24U298">nk</span>(<span class="mxinfo" id="T34:U219"><span class="mxinfo" id="T2:U220">7</span>:<span class="mxinfo" id="T2:U221">9</span></span>,<span class="var type1" id="S17T2U302">k</span>)</span></span>)</span> - <span class="mxinfo" id="T27:U223"><span class="var type1" id="S4T24U304">nk</span>(<span class="mxinfo" id="T34:U225"><span class="mxinfo" id="T2:U226">10</span>:<span class="mxinfo" id="T2:U227">12</span></span>,<span class="var type1" id="S17T2U308">k</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50">50</a></span><span class="line">    <span class="comment">% feature measurements</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51">51</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S29T2U311">kk</span> = <span class="mxinfo" id="T2:U230">1</span>:<span class="var type1" id="S7T2U314">m1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52">52</a></span><span class="line">        <span class="comment">% get the i frame vector to the feature</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53">53</a></span><span class="line">        <span class="mxinfo" id="T27:U232"><span class="var type1" id="S30T27U317">rki</span> = <span class="mxinfo" id="T27:U234"><span class="var type1" id="S22T26U319">Cin</span>*(<span class="mxinfo" id="T27:U236"><span class="mxinfo" id="T50:U237"><span class="mxinfo" id="T51:U238"><span class="var type1" id="S10T42U324">RKN_1</span>(<span class="var type1" id="S29T2U325">kk</span>,:)</span>'</span> - <span class="var type1" id="S20T27U327">rin</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54">54</a></span><span class="line">        <span class="comment">% the index for now</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55">55</a></span><span class="line">        <span class="mxinfo" id="T34:U242"><span class="var type1" id="S31T34U330">index</span> = <span class="mxinfo" id="T34:U244"><span class="mxinfo" id="T2:U245">(<span class="mxinfo" id="T2:U246"><span class="var type1" id="S29T2U335">kk</span>-<span class="mxinfo" id="T2:U248">1</span></span>)*<span class="mxinfo" id="T2:U249">3</span></span> + (<span class="mxinfo" id="T34:U250">1:3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56">56</a></span><span class="line">        <span class="comment">% compute range/bearing/declination</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57">57</a></span><span class="line">        <span class="mxinfo" id="T27:U251"><span class="var type1" id="S32T27U344">y_kk</span> = <span class="mxinfo" id="T27:U253"><span class="mxinfo" id="T27:U254">[<span class="mxinfo" id="T2:U255">sqrt(<span class="mxinfo" id="T2:U256">sum(<span class="mxinfo" id="T27:U257"><span class="var type1" id="S30T27U353">rki</span>.^2</span>)</span>)</span>;<span class="mxinfo" id="T2:U259">atan2(<span class="mxinfo" id="T2:U260"><span class="var type1" id="S30T27U359">rki</span>(<span class="mxinfo" id="T2:U262">2</span>)</span>,<span class="mxinfo" id="T2:U263"><span class="var type1" id="S30T27U362">rki</span>(<span class="mxinfo" id="T2:U265">1</span>)</span>)</span>;<span class="mxinfo" id="T2:U266">atan2(<span class="mxinfo" id="T2:U267"><span class="var type1" id="S30T27U368">rki</span>(<span class="mxinfo" id="T2:U269">3</span>)</span>,<span class="mxinfo" id="T2:U270">sqrt(<span class="mxinfo" id="T2:U271">sum(<span class="mxinfo" id="T31:U272"><span class="mxinfo" id="T31:U273"><span class="var type1" id="S30T27U376">rki</span>(<span class="mxinfo" id="T15:U275"><span class="mxinfo" id="T2:U276">1</span>:<span class="mxinfo" id="T2:U277">2</span></span>)</span>.^2</span>)</span>)</span>)</span>]</span> + <span class="mxinfo" id="T27:U278"><span class="var type1" id="S4T24U382">nk</span>(<span class="mxinfo" id="T34:U280"><span class="mxinfo" id="T2:U281">12</span> + <span class="var type1" id="S31T34U385">index</span></span>,<span class="var type1" id="S17T2U386">k</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58">58</a></span><span class="line">        <span class="mxinfo" id="T27:U284"><span class="mxinfo" id="T27:U285"><span class="var type1" id="S2T43U390">yk</span>(<span class="mxinfo" id="T34:U287"><span class="mxinfo" id="T2:U288">9</span> + <span class="var type1" id="S31T34U393">index</span></span>,<span class="var type1" id="S17T2U394">k</span>)</span> = <span class="var type1" id="S32T27U395">y_kk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59">59</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60">60</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61">61</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S29T2U398">kk</span> = <span class="mxinfo" id="T2:U293">1</span>:<span class="var type1" id="S8T2U401">m2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62">62</a></span><span class="line">        <span class="comment">% get the j frame vector to the feature</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63">63</a></span><span class="line">        <span class="mxinfo" id="T27:U295"><span class="var type1" id="S33T27U404">rkj</span> = <span class="mxinfo" id="T27:U297"><span class="mxinfo" id="T26:U298"><span class="var type1" id="S24T26U407">Cji</span>*<span class="var type1" id="S22T26U408">Cin</span></span>*(<span class="mxinfo" id="T27:U301"><span class="mxinfo" id="T27:U302"><span class="mxinfo" id="T50:U303"><span class="mxinfo" id="T51:U304"><span class="var type1" id="S12T42U414">RKN_2</span>(<span class="var type1" id="S29T2U415">kk</span>,:)</span>'</span> - <span class="mxinfo" id="T27:U307"><span class="mxinfo" id="T26:U308"><span class="var type1" id="S22T26U419">Cin</span>'</span>*<span class="var type1" id="S19T27U420">rji_i_hat</span></span></span> - <span class="var type1" id="S20T27U421">rin</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64">64</a></span><span class="line">        <span class="comment">% the index for now</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65">65</a></span><span class="line">        <span class="mxinfo" id="T34:U312"><span class="var type1" id="S31T34U424">index</span> = <span class="mxinfo" id="T34:U314"><span class="mxinfo" id="T34:U315"><span class="mxinfo" id="T2:U316">(<span class="mxinfo" id="T2:U317"><span class="var type1" id="S29T2U430">kk</span>-<span class="mxinfo" id="T2:U319">1</span></span>)*<span class="mxinfo" id="T2:U320">3</span></span> + (<span class="mxinfo" id="T34:U321">1:3</span>)</span> + <span class="mxinfo" id="T2:U322"><span class="var type1" id="S7T2U438">m1</span>*<span class="mxinfo" id="T2:U324">3</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66">66</a></span><span class="line">        <span class="comment">% compute range/bearing/declination</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67">67</a></span><span class="line">        <span class="mxinfo" id="T27:U325"><span class="var type1" id="S32T27U442">y_kk</span> = <span class="mxinfo" id="T27:U327"><span class="mxinfo" id="T27:U328">[<span class="mxinfo" id="T2:U329">sqrt(<span class="mxinfo" id="T2:U330">sum(<span class="mxinfo" id="T27:U331"><span class="var type1" id="S33T27U451">rkj</span>.^2</span>)</span>)</span>;<span class="mxinfo" id="T2:U333">atan2(<span class="mxinfo" id="T2:U334"><span class="var type1" id="S33T27U457">rkj</span>(<span class="mxinfo" id="T2:U336">2</span>)</span>,<span class="mxinfo" id="T2:U337"><span class="var type1" id="S33T27U460">rkj</span>(<span class="mxinfo" id="T2:U339">1</span>)</span>)</span>;<span class="mxinfo" id="T2:U340">atan2(<span class="mxinfo" id="T2:U341"><span class="var type1" id="S33T27U466">rkj</span>(<span class="mxinfo" id="T2:U343">3</span>)</span>,<span class="mxinfo" id="T2:U344">sqrt(<span class="mxinfo" id="T2:U345">sum(<span class="mxinfo" id="T31:U346"><span class="mxinfo" id="T31:U347"><span class="var type1" id="S33T27U474">rkj</span>(<span class="mxinfo" id="T15:U349"><span class="mxinfo" id="T2:U350">1</span>:<span class="mxinfo" id="T2:U351">2</span></span>)</span>.^2</span>)</span>)</span>)</span>]</span> + <span class="mxinfo" id="T27:U352"><span class="var type1" id="S4T24U480">nk</span>(<span class="mxinfo" id="T34:U354"><span class="mxinfo" id="T2:U355">12</span> + <span class="var type1" id="S31T34U483">index</span></span>,<span class="var type1" id="S17T2U484">k</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68">68</a></span><span class="line">        <span class="mxinfo" id="T27:U358"><span class="mxinfo" id="T27:U359"><span class="var type1" id="S2T43U488">yk</span>(<span class="mxinfo" id="T34:U361"><span class="mxinfo" id="T2:U362">9</span> + <span class="var type1" id="S31T34U491">index</span></span>,<span class="var type1" id="S17T2U492">k</span>)</span> = <span class="var type1" id="S32T27U493">y_kk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69">69</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70">70</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71">71</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T3:U366"><span class="var type1" id="S17T2U497">k</span> &gt; <span class="mxinfo" id="T2:U368">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72">72</a></span><span class="line">        <span class="comment">% minimize all angle differences</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73">73</a></span><span class="line">        <span class="mxinfo" id="T25:U369"><span class="mxinfo" id="T25:U370"><span class="var type1" id="S2T43U502">yk</span>(<span class="mxinfo" id="T25:U372">[<span class="mxinfo" id="T2:U373">2</span>;<span class="mxinfo" id="T2:U374">3</span>;<span class="mxinfo" id="T2:U375">5</span>;<span class="mxinfo" id="T2:U376">6</span>]</span>,<span class="var type1" id="S17T2U512">k</span>)</span> = <span class="mxinfo" id="T25:U378"><span class="fcn" id="F221N6:B514">minangle</span>(<span class="mxinfo" id="T25:U379"><span class="var type1" id="S2T43U516">yk</span>(<span class="mxinfo" id="T25:U381">[<span class="mxinfo" id="T2:U382">2</span>;<span class="mxinfo" id="T2:U383">3</span>;<span class="mxinfo" id="T2:U384">5</span>;<span class="mxinfo" id="T2:U385">6</span>]</span>,<span class="var type1" id="S17T2U526">k</span>)</span>,<span class="mxinfo" id="T25:U387"><span class="var type1" id="S2T43U528">yk</span>(<span class="mxinfo" id="T25:U389">[<span class="mxinfo" id="T2:U390">2</span>;<span class="mxinfo" id="T2:U391">3</span>;<span class="mxinfo" id="T2:U392">5</span>;<span class="mxinfo" id="T2:U393">6</span>]</span>,<span class="mxinfo" id="T2:U394">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74">74</a></span><span class="line">        <span class="mxinfo" id="T11:U395"><span class="mxinfo" id="T11:U396"><span class="var type1" id="S2T43U542">yk</span>( <span class="mxinfo" id="T10:U398"><span class="mxinfo" id="T2:U399">9</span> + (<span class="mxinfo" id="T10:U400">2:3:<span class="mxinfo" id="T2:U401"><span class="mxinfo" id="T2:U402">3</span>*<span class="var type1" id="S7T2U552">m1</span></span></span>)</span>,<span class="var type1" id="S17T2U553">k</span> )</span> = <span class="mxinfo" id="T11:U405"><span class="fcn" id="F252N6:B555">minangle</span>(<span class="mxinfo" id="T11:U406"><span class="var type1" id="S2T43U557">yk</span>(<span class="mxinfo" id="T10:U408"><span class="mxinfo" id="T2:U409">9</span> + (<span class="mxinfo" id="T10:U410">2:3:<span class="mxinfo" id="T2:U411"><span class="mxinfo" id="T2:U412">3</span>*<span class="var type1" id="S7T2U567">m1</span></span></span>)</span>,<span class="var type1" id="S17T2U568">k</span>)</span>,<span class="mxinfo" id="T11:U415"><span class="var type1" id="S2T43U570">yk</span>(<span class="mxinfo" id="T10:U417"><span class="mxinfo" id="T2:U418">9</span> + (<span class="mxinfo" id="T10:U419">2:3:<span class="mxinfo" id="T2:U420"><span class="mxinfo" id="T2:U421">3</span>*<span class="var type1" id="S7T2U580">m1</span></span></span>)</span>,<span class="mxinfo" id="T2:U423">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75">75</a></span><span class="line">        <span class="mxinfo" id="T11:U424"><span class="mxinfo" id="T11:U425"><span class="var type1" id="S2T43U585">yk</span>( <span class="mxinfo" id="T10:U427"><span class="mxinfo" id="T2:U428">9</span> + (<span class="mxinfo" id="T10:U429">3:3:<span class="mxinfo" id="T2:U430"><span class="mxinfo" id="T2:U431">3</span>*<span class="var type1" id="S7T2U595">m1</span></span></span>)</span>,<span class="var type1" id="S17T2U596">k</span> )</span> = <span class="mxinfo" id="T11:U434"><span class="fcn" id="F252N6:B598">minangle</span>(<span class="mxinfo" id="T11:U435"><span class="var type1" id="S2T43U600">yk</span>(<span class="mxinfo" id="T10:U437"><span class="mxinfo" id="T2:U438">9</span> + (<span class="mxinfo" id="T10:U439">3:3:<span class="mxinfo" id="T2:U440"><span class="mxinfo" id="T2:U441">3</span>*<span class="var type1" id="S7T2U610">m1</span></span></span>)</span>,<span class="var type1" id="S17T2U611">k</span>)</span>,<span class="mxinfo" id="T11:U444"><span class="var type1" id="S2T43U613">yk</span>(<span class="mxinfo" id="T10:U446"><span class="mxinfo" id="T2:U447">9</span> + (<span class="mxinfo" id="T10:U448">3:3:<span class="mxinfo" id="T2:U449"><span class="mxinfo" id="T2:U450">3</span>*<span class="var type1" id="S7T2U623">m1</span></span></span>)</span>,<span class="mxinfo" id="T2:U452">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76">76</a></span><span class="line">        <span class="mxinfo" id="T11:U453"><span class="mxinfo" id="T11:U454"><span class="var type1" id="S2T43U628">yk</span>( <span class="mxinfo" id="T10:U456"><span class="mxinfo" id="T2:U457"><span class="mxinfo" id="T2:U458">9</span> + <span class="mxinfo" id="T2:U459"><span class="mxinfo" id="T2:U460">3</span>*<span class="var type1" id="S7T2U634">m1</span></span></span> + (<span class="mxinfo" id="T10:U462">2:3:<span class="mxinfo" id="T2:U463"><span class="mxinfo" id="T2:U464">3</span>*<span class="var type1" id="S8T2U642">m2</span></span></span>)</span>,<span class="var type1" id="S17T2U643">k</span> )</span> = <span class="mxinfo" id="T11:U467"><span class="fcn" id="F252N6:B645">minangle</span>( <span class="mxinfo" id="T11:U468"><span class="var type1" id="S2T43U647">yk</span>( <span class="mxinfo" id="T10:U470"><span class="mxinfo" id="T2:U471"><span class="mxinfo" id="T2:U472">9</span> + <span class="mxinfo" id="T2:U473"><span class="mxinfo" id="T2:U474">3</span>*<span class="var type1" id="S7T2U653">m1</span></span></span> + (<span class="mxinfo" id="T10:U476">2:3:<span class="mxinfo" id="T2:U477"><span class="mxinfo" id="T2:U478">3</span>*<span class="var type1" id="S8T2U661">m2</span></span></span>)</span>,<span class="var type1" id="S17T2U662">k</span> )</span>, <span class="mxinfo" id="T11:U481"><span class="var type1" id="S2T43U664">yk</span>( <span class="mxinfo" id="T10:U483"><span class="mxinfo" id="T2:U484"><span class="mxinfo" id="T2:U485">9</span> + <span class="mxinfo" id="T2:U486"><span class="mxinfo" id="T2:U487">3</span>*<span class="var type1" id="S7T2U670">m1</span></span></span> + (<span class="mxinfo" id="T10:U489">2:3:<span class="mxinfo" id="T2:U490"><span class="mxinfo" id="T2:U491">3</span>*<span class="var type1" id="S8T2U678">m2</span></span></span>)</span>,<span class="mxinfo" id="T2:U493">1</span> )</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77">77</a></span><span class="line">        <span class="mxinfo" id="T11:U494"><span class="mxinfo" id="T11:U495"><span class="var type1" id="S2T43U683">yk</span>( <span class="mxinfo" id="T10:U497"><span class="mxinfo" id="T2:U498"><span class="mxinfo" id="T2:U499">9</span> + <span class="mxinfo" id="T2:U500"><span class="mxinfo" id="T2:U501">3</span>*<span class="var type1" id="S7T2U689">m1</span></span></span> + (<span class="mxinfo" id="T10:U503">3:3:<span class="mxinfo" id="T2:U504"><span class="mxinfo" id="T2:U505">3</span>*<span class="var type1" id="S8T2U697">m2</span></span></span>)</span>,<span class="var type1" id="S17T2U698">k</span> )</span> = <span class="mxinfo" id="T11:U508"><span class="fcn" id="F252N6:B700">minangle</span>( <span class="mxinfo" id="T11:U509"><span class="var type1" id="S2T43U702">yk</span>( <span class="mxinfo" id="T10:U511"><span class="mxinfo" id="T2:U512"><span class="mxinfo" id="T2:U513">9</span> + <span class="mxinfo" id="T2:U514"><span class="mxinfo" id="T2:U515">3</span>*<span class="var type1" id="S7T2U708">m1</span></span></span> + (<span class="mxinfo" id="T10:U517">3:3:<span class="mxinfo" id="T2:U518"><span class="mxinfo" id="T2:U519">3</span>*<span class="var type1" id="S8T2U716">m2</span></span></span>)</span>,<span class="var type1" id="S17T2U717">k</span> )</span>, <span class="mxinfo" id="T11:U522"><span class="var type1" id="S2T43U719">yk</span>( <span class="mxinfo" id="T10:U524"><span class="mxinfo" id="T2:U525"><span class="mxinfo" id="T2:U526">9</span> + <span class="mxinfo" id="T2:U527"><span class="mxinfo" id="T2:U528">3</span>*<span class="var type1" id="S7T2U725">m1</span></span></span> + (<span class="mxinfo" id="T10:U530">3:3:<span class="mxinfo" id="T2:U531"><span class="mxinfo" id="T2:U532">3</span>*<span class="var type1" id="S8T2U733">m2</span></span></span>)</span>,<span class="mxinfo" id="T2:U534">1</span> )</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78">78</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79">79</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80">80</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81">81</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
