<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">xnew</span>,<span class="var type1" id="S3T5U4">Pnew</span>] = ukf_update_unknown_state(<span class="var type1" id="S4T1U7">xk</span>,<span class="var type1" id="S5T5U8">Pxk</span>,<span class="var type1" id="S6T6U9">Pvk</span>,<span class="var type1" id="S7T5U10">Pnk</span>,<span class="var type1" id="S8T4U11">uk</span>,<span class="var type1" id="S9T1U12">ytilde</span>,<span class="var type1" id="S10T3U13">alpha</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% Pxk: covariance associated with state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% Pvk: covariance associated with process noise</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% Pnk: covariance assocaited with measurement noise</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% vector lengths</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="mxinfo" id="T3:U10"><span class="var type1" id="S11T3U16">n</span> = <span class="mxinfo" id="T3:U12">length(<span class="var type1" id="S4T1U19">xk</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="mxinfo" id="T3:U14"><span class="var type1" id="S13T3U22">m</span> = <span class="mxinfo" id="T3:U16">length(<span class="var type1" id="S8T4U25">uk</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="mxinfo" id="T3:U18"><span class="var type1" id="S14T3U28">nl</span> = <span class="mxinfo" id="T3:U20">size(<span class="var type1" id="S7T5U31">Pnk</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="mxinfo" id="T3:U22"><span class="var type1" id="S16T3U35">vl</span> = <span class="mxinfo" id="T3:U24">size(<span class="var type1" id="S6T6U38">Pvk</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="mxinfo" id="T3:U26"><span class="var type1" id="S17T3U42">N</span> = <span class="mxinfo" id="T3:U28"><span class="mxinfo" id="T3:U29"><span class="var type1" id="S11T3U45">n</span>+<span class="var type1" id="S14T3U46">nl</span></span>+<span class="var type1" id="S16T3U47">vl</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% number of known features seen by agents i and j (1 and 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="mxinfo" id="T3:U33"><span class="var type1" id="S18T3U50">m1</span> = <span class="mxinfo" id="T3:U35"><span class="var type1" id="S8T4U52">uk</span>(<span class="mxinfo" id="T3:U37">10</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="mxinfo" id="T3:U38"><span class="var type1" id="S19T3U56">m2</span> = <span class="mxinfo" id="T3:U40"><span class="var type1" id="S8T4U58">uk</span>(<span class="mxinfo" id="T3:U42"><span class="mxinfo" id="T3:U43"><span class="mxinfo" id="T3:U44">10</span> + <span class="mxinfo" id="T3:U45">1</span></span> + <span class="mxinfo" id="T3:U46"><span class="mxinfo" id="T3:U47">3</span>*<span class="var type1" id="S18T3U65">m1</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo" id="T3:U49"><span class="var type1" id="S20T3U68">w1</span> = <span class="mxinfo" id="T3:U51"><span class="var type1" id="S8T4U70">uk</span>(<span class="mxinfo" id="T3:U53"><span class="mxinfo" id="T3:U54"><span class="mxinfo" id="T3:U55"><span class="mxinfo" id="T3:U56">10</span> + <span class="mxinfo" id="T3:U57">2</span></span> + <span class="mxinfo" id="T3:U58"><span class="mxinfo" id="T3:U59">3</span>*<span class="var type1" id="S18T3U78">m1</span></span></span> + <span class="mxinfo" id="T3:U61"><span class="mxinfo" id="T3:U62">3</span>*<span class="var type1" id="S19T3U81">m2</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo" id="T3:U64"><span class="var type1" id="S21T3U84">w2</span> = <span class="mxinfo" id="T3:U66"><span class="var type1" id="S8T4U86">uk</span>(<span class="mxinfo" id="T3:U68"><span class="mxinfo" id="T3:U69"><span class="mxinfo" id="T3:U70"><span class="mxinfo" id="T3:U71"><span class="mxinfo" id="T3:U72"><span class="mxinfo" id="T3:U73">10</span> + <span class="mxinfo" id="T3:U74">2</span></span> + <span class="mxinfo" id="T3:U75"><span class="mxinfo" id="T3:U76">3</span>*<span class="var type1" id="S18T3U96">m1</span></span></span> + <span class="mxinfo" id="T3:U78"><span class="mxinfo" id="T3:U79">3</span>*<span class="var type1" id="S19T3U99">m2</span></span></span> + <span class="var type1" id="S20T3U100">w1</span></span> + <span class="mxinfo" id="T3:U82">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">% constant gamma that influences sigma points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="keyword">if</span> nargin &lt; 7</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line">    <span class="var type2" id="S10T0U110">alpha</span> = 1e-3;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="mxinfo" id="T3:U83"><span class="var type1" id="S23T3U114">Kappa</span> = <span class="mxinfo" id="T3:U85">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo" id="T3:U86"><span class="var type1" id="S24T3U118">lambda</span> = <span class="mxinfo" id="T3:U88"><span class="mxinfo" id="T3:U89"><span class="mxinfo" id="T3:U90"><span class="var type1" id="S10T3U122">alpha</span>^2</span>*(<span class="mxinfo" id="T3:U92"><span class="var type1" id="S17T3U126">N</span>+<span class="mxinfo" id="T3:U94"><span class="var type1" id="S23T3U127">Kappa</span></span></span>)</span>-<span class="var type1" id="S17T3U128">N</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="mxinfo" id="T3:U97"><span class="var type1" id="S25T3U131">gamm</span> = <span class="mxinfo" id="T3:U99">sqrt(<span class="mxinfo" id="T3:U100"><span class="var type1" id="S17T3U135">N</span>+<span class="var type1" id="S24T3U136">lambda</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">%augmented covariance and state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="mxinfo" id="T64:U103"><span class="var type1" id="S27T64U139">Paug</span> = <span class="mxinfo" id="T64:U105">zeros(<span class="var type1" id="S17T3U142">N</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo" id="T5:U107"><span class="mxinfo" id="T5:U108"><span class="var type1" id="S27T64U146">Paug</span>(<span class="mxinfo" id="T9:U110"><span class="mxinfo" id="T3:U111">1</span>:<span class="var type1" id="S11T3U149">n</span></span>,<span class="mxinfo" id="T9:U113"><span class="mxinfo" id="T3:U114">1</span>:<span class="var type1" id="S11T3U152">n</span></span>)</span> = <span class="var type1" id="S5T5U153">Pxk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="mxinfo" id="T6:U117"><span class="mxinfo" id="T6:U118"><span class="var type1" id="S27T64U157">Paug</span>(<span class="mxinfo" id="T81:U120"><span class="var type1" id="S11T3U159">n</span>+(<span class="mxinfo" id="T18:U122">1:<span class="var type1" id="S16T3U163">vl</span></span>)</span>,<span class="mxinfo" id="T81:U124"><span class="var type1" id="S11T3U165">n</span>+(<span class="mxinfo" id="T18:U126">1:<span class="var type1" id="S16T3U169">vl</span></span>)</span>)</span> = <span class="var type1" id="S6T6U170">Pvk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo" id="T5:U129"><span class="mxinfo" id="T5:U130"><span class="var type1" id="S27T64U174">Paug</span>(<span class="mxinfo" id="T82:U132"><span class="mxinfo" id="T3:U133"><span class="var type1" id="S11T3U177">n</span>+<span class="var type1" id="S16T3U178">vl</span></span>+(<span class="mxinfo" id="T18:U136">1:<span class="var type1" id="S14T3U182">nl</span></span>)</span>,<span class="mxinfo" id="T82:U138"><span class="mxinfo" id="T3:U139"><span class="var type1" id="S11T3U185">n</span>+<span class="var type1" id="S16T3U186">vl</span></span>+(<span class="mxinfo" id="T18:U142">1:<span class="var type1" id="S14T3U190">nl</span></span>)</span>)</span> = <span class="var type1" id="S7T5U191">Pnk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo" id="T65:U145"><span class="var type1" id="S29T65U194">xaug</span> = <span class="mxinfo" id="T65:U147">[<span class="var type1" id="S4T1U197">xk</span>;<span class="mxinfo" id="T83:U149">zeros(<span class="mxinfo" id="T3:U150"><span class="var type1" id="S14T3U202">nl</span>+<span class="var type1" id="S16T3U203">vl</span></span>,1)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="mxinfo" id="T37:U153">[<span class="var type1" id="S30T66U208">Psq</span>,<span class="var type1" id="S31T3U209">resnorm</span>] = sqrtm(<span class="var type1" id="S27T64U212">Paug</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="keyword">if</span> (<span class="mxinfo" id="T9:U157"><span class="mxinfo" id="T3:U158">abs(<span class="var type1" id="S31T3U219">resnorm</span>)</span> &gt; <span class="mxinfo" id="T3:U160">1e-14</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">    fprintf(<span class="string">'Error: matrix square root residual norm is %g.\n'</span>,<span class="var type1" id="S31T3U225">resnorm</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">    <span class="mxinfo" id="T1:U162"><span class="var type1" id="S2T1U228">xnew</span> = <span class="mxinfo" id="T3:U164">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">    <span class="mxinfo" id="T5:U165"><span class="var type1" id="S3T5U232">Pnew</span> = <span class="mxinfo" id="T3:U167">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="mxinfo" id="T64:U168"><span class="var type1" id="S30T64U237">Psq</span> = <span class="mxinfo" id="T64:U170">real(<span class="var type1" id="S30T66U240">Psq</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">% compute the sigma points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="mxinfo" id="T67:U172"><span class="var type1" id="S36T67U243">XAUG</span> = <span class="mxinfo" id="T67:U174">zeros(<span class="var type1" id="S17T3U246">N</span>,<span class="mxinfo" id="T3:U176"><span class="mxinfo" id="T3:U177"><span class="mxinfo" id="T3:U178">2</span>*<span class="var type1" id="S17T3U250">N</span></span>+<span class="mxinfo" id="T3:U180">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="mxinfo" id="T65:U181"><span class="mxinfo" id="T65:U182"><span class="var type1" id="S36T67U255">XAUG</span>(:,<span class="mxinfo" id="T3:U184">1</span>)</span> = <span class="var type1" id="S29T65U258">xaug</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S37T3U261">k</span> = <span class="mxinfo" id="T3:U187">1</span>:<span class="var type1" id="S17T3U264">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">    <span class="mxinfo" id="T65:U189"><span class="mxinfo" id="T65:U190"><span class="var type1" id="S36T67U268">XAUG</span>(:,<span class="mxinfo" id="T3:U192"><span class="var type1" id="S37T3U271">k</span>+<span class="mxinfo" id="T3:U194">1</span></span>)</span> = <span class="mxinfo" id="T65:U195"><span class="var type1" id="S29T65U274">xaug</span> + <span class="mxinfo" id="T2:U197"><span class="var type1" id="S25T3U276">gamm</span>*<span class="mxinfo" id="T65:U199"><span class="var type1" id="S30T64U278">Psq</span>(:,<span class="var type1" id="S37T3U280">k</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">    <span class="mxinfo" id="T65:U202"><span class="mxinfo" id="T65:U203"><span class="var type1" id="S36T67U284">XAUG</span>(:,<span class="mxinfo" id="T3:U205"><span class="mxinfo" id="T3:U206"><span class="var type1" id="S17T3U288">N</span>+<span class="mxinfo" id="T3:U208">1</span></span>+<span class="var type1" id="S37T3U290">k</span></span>)</span> = <span class="mxinfo" id="T65:U210"><span class="var type1" id="S29T65U292">xaug</span> - <span class="mxinfo" id="T2:U212"><span class="var type1" id="S25T3U294">gamm</span>*<span class="mxinfo" id="T65:U214"><span class="var type1" id="S30T64U296">Psq</span>(:,<span class="var type1" id="S37T3U298">k</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="comment">% propagate the sigma points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"><span class="mxinfo" id="T68:U217"><span class="var type1" id="S38T68U301">XAUGPLUS</span> = <span class="mxinfo" id="T68:U219"><span class="fcn" id="F406N13:B303">update_eq_unknown_state</span>(<span class="mxinfo" id="T68:U220"><span class="var type1" id="S36T67U305">XAUG</span>(<span class="mxinfo" id="T9:U222"><span class="mxinfo" id="T3:U223">1</span>:<span class="var type1" id="S11T3U308">n</span></span>,:)</span>,<span class="mxinfo" id="T73:U225"><span class="var type1" id="S36T67U311">XAUG</span>(<span class="mxinfo" id="T81:U227"><span class="var type1" id="S11T3U313">n</span>+(<span class="mxinfo" id="T18:U229">1:<span class="var type1" id="S16T3U317">vl</span></span>)</span>,:)</span>,<span class="var type1" id="S8T4U319">uk</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="comment">% weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="mxinfo" id="T3:U232"><span class="var type1" id="S40T3U322">beta</span> = <span class="mxinfo" id="T3:U234">2</span></span>;<span class="comment">% optimal for Gaussian</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="mxinfo" id="T69:U235"><span class="var type1" id="S41T69U326">wc</span> = <span class="mxinfo" id="T2:U237"><span class="mxinfo" id="T3:U238"><span class="mxinfo" id="T3:U239">0.5</span>/(<span class="mxinfo" id="T3:U240"><span class="var type1" id="S17T3U332">N</span>+<span class="var type1" id="S24T3U333">lambda</span></span>)</span>*<span class="mxinfo" id="T69:U243">ones(<span class="mxinfo" id="T3:U244"><span class="mxinfo" id="T3:U245"><span class="mxinfo" id="T3:U246">2</span>*<span class="var type1" id="S17T3U339">N</span></span>+<span class="mxinfo" id="T3:U248">1</span></span>,1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="mxinfo" id="T69:U249"><span class="var type1" id="S43T69U344">wm</span> = <span class="mxinfo" id="T2:U251"><span class="mxinfo" id="T3:U252"><span class="mxinfo" id="T3:U253">0.5</span>/(<span class="mxinfo" id="T3:U254"><span class="var type1" id="S17T3U350">N</span>+<span class="var type1" id="S24T3U351">lambda</span></span>)</span>*<span class="mxinfo" id="T69:U257">ones(<span class="mxinfo" id="T3:U258"><span class="mxinfo" id="T3:U259"><span class="mxinfo" id="T3:U260">2</span>*<span class="var type1" id="S17T3U357">N</span></span>+<span class="mxinfo" id="T3:U262">1</span></span>,1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="mxinfo" id="T3:U263"><span class="mxinfo" id="T3:U264"><span class="var type1" id="S43T69U363">wm</span>(<span class="mxinfo" id="T3:U266">1</span>)</span> = <span class="mxinfo" id="T3:U267"><span class="var type1" id="S24T3U366">lambda</span>/(<span class="mxinfo" id="T3:U269"><span class="var type1" id="S17T3U369">N</span>+<span class="var type1" id="S24T3U370">lambda</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="mxinfo" id="T3:U272"><span class="mxinfo" id="T3:U273"><span class="var type1" id="S41T69U374">wc</span>(<span class="mxinfo" id="T3:U275">1</span>)</span> = <span class="mxinfo" id="T3:U276"><span class="mxinfo" id="T3:U277"><span class="mxinfo" id="T3:U278"><span class="mxinfo" id="T3:U279"><span class="var type1" id="S24T3U380">lambda</span>/(<span class="mxinfo" id="T3:U281"><span class="var type1" id="S17T3U383">N</span>+<span class="var type1" id="S24T3U384">lambda</span></span>)</span> + <span class="mxinfo" id="T3:U284">1</span></span>-<span class="mxinfo" id="T3:U285"><span class="var type1" id="S10T3U387">alpha</span>^2</span></span>+<span class="mxinfo" id="T3:U287"><span class="var type1" id="S40T3U389">beta</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="comment">% calculate the update</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="mxinfo" id="T1:U289"><span class="var type1" id="S44T1U392">xp</span> = <span class="mxinfo" id="T2:U291">sum(<span class="mxinfo" id="T68:U292"><span class="mxinfo" id="T68:U293"><span class="var type1" id="S38T68U397">XAUGPLUS</span>(<span class="mxinfo" id="T9:U295"><span class="mxinfo" id="T3:U296">1</span>:<span class="var type1" id="S11T3U400">n</span></span>,:)</span>.*<span class="mxinfo" id="T70:U298">repmat(<span class="mxinfo" id="T76:U299"><span class="var type1" id="S43T69U405">wm</span>'</span>,<span class="var type1" id="S11T3U406">n</span>,1)</span></span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">% re-normalize</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="mxinfo" id="T84:U302"><span class="mxinfo" id="T84:U303"><span class="var type1" id="S44T1U412">xp</span>(<span class="mxinfo" id="T84:U305"><span class="mxinfo" id="T3:U306">7</span>:<span class="mxinfo" id="T3:U307">10</span></span>)</span> = <span class="mxinfo" id="T43:U308"><span class="mxinfo" id="T43:U309"><span class="var type1" id="S44T1U418">xp</span>(<span class="mxinfo" id="T84:U311"><span class="mxinfo" id="T3:U312">7</span>:<span class="mxinfo" id="T3:U313">10</span></span>)</span>/<span class="mxinfo" id="T3:U314">norm(<span class="mxinfo" id="T43:U315"><span class="var type1" id="S44T1U425">xp</span>(<span class="mxinfo" id="T84:U317"><span class="mxinfo" id="T3:U318">7</span>:<span class="mxinfo" id="T3:U319">10</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="mxinfo" id="T84:U320"><span class="mxinfo" id="T84:U321"><span class="var type1" id="S44T1U432">xp</span>(<span class="mxinfo" id="T84:U323"><span class="mxinfo" id="T3:U324">14</span>:<span class="mxinfo" id="T3:U325">17</span></span>)</span> = <span class="mxinfo" id="T43:U326"><span class="mxinfo" id="T43:U327"><span class="var type1" id="S44T1U438">xp</span>(<span class="mxinfo" id="T84:U329"><span class="mxinfo" id="T3:U330">14</span>:<span class="mxinfo" id="T3:U331">17</span></span>)</span>/<span class="mxinfo" id="T3:U332">norm(<span class="mxinfo" id="T43:U333"><span class="var type1" id="S44T1U445">xp</span>(<span class="mxinfo" id="T84:U335"><span class="mxinfo" id="T3:U336">14</span>:<span class="mxinfo" id="T3:U337">17</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="mxinfo" id="T5:U338"><span class="var type1" id="S48T5U451">Pp</span> = <span class="mxinfo" id="T5:U340">zeros(<span class="var type1" id="S11T3U454">n</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S37T3U457">k</span> = <span class="mxinfo" id="T3:U343">1</span>:<span class="mxinfo" id="T3:U344"><span class="mxinfo" id="T3:U345"><span class="mxinfo" id="T3:U346">2</span>*<span class="var type1" id="S17T3U463">N</span></span>+<span class="mxinfo" id="T3:U348">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">    <span class="mxinfo" id="T5:U349"><span class="var type1" id="S48T5U467">Pp</span> = <span class="mxinfo" id="T5:U351"><span class="var type1" id="S48T5U469">Pp</span> + <span class="mxinfo" id="T12:U353"><span class="mxinfo" id="T2:U354"><span class="mxinfo" id="T3:U355"><span class="var type1" id="S41T69U473">wc</span>(<span class="var type1" id="S37T3U474">k</span>)</span>*(<span class="mxinfo" id="T1:U358"><span class="mxinfo" id="T1:U359"><span class="var type1" id="S38T68U478">XAUGPLUS</span>(<span class="mxinfo" id="T9:U361"><span class="mxinfo" id="T3:U362">1</span>:<span class="var type1" id="S11T3U481">n</span></span>,<span class="var type1" id="S37T3U482">k</span>)</span>-<span class="var type1" id="S44T1U483">xp</span></span>)</span>*<span class="mxinfo" id="T82:U366">(<span class="mxinfo" id="T1:U367"><span class="mxinfo" id="T1:U368"><span class="var type1" id="S38T68U488">XAUGPLUS</span>(<span class="mxinfo" id="T9:U370"><span class="mxinfo" id="T3:U371">1</span>:<span class="var type1" id="S11T3U491">n</span></span>,<span class="var type1" id="S37T3U492">k</span>)</span>-<span class="var type1" id="S44T1U493">xp</span></span>)'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="comment">% pass the sigma points through the measurement function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="mxinfo" id="T70:U375"><span class="var type1" id="S49T70U496">YKAUG</span> = <span class="mxinfo" id="T70:U377"><span class="fcn" id="F589N7:B498">measurement_eq_unknown_state</span>(<span class="mxinfo" id="T68:U378"><span class="var type1" id="S38T68U500">XAUGPLUS</span>(<span class="mxinfo" id="T9:U380"><span class="mxinfo" id="T3:U381">1</span>:<span class="var type1" id="S11T3U503">n</span></span>,:)</span>,<span class="mxinfo" id="T68:U383"><span class="var type1" id="S36T67U506">XAUG</span>(<span class="mxinfo" id="T82:U385"><span class="mxinfo" id="T3:U386"><span class="var type1" id="S11T3U509">n</span>+<span class="var type1" id="S16T3U510">vl</span></span>+(<span class="mxinfo" id="T18:U389">1:<span class="var type1" id="S14T3U514">nl</span></span>)</span>,:)</span>,<span class="var type1" id="S8T4U516">uk</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="mxinfo" id="T3:U392"><span class="var type1" id="S51T3U519">g</span> = <span class="mxinfo" id="T3:U394">size(<span class="var type1" id="S49T70U522">YKAUG</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="mxinfo" id="T2:U396"><span class="var type1" id="S52T2U526">yhat</span> = <span class="mxinfo" id="T2:U398">sum(<span class="mxinfo" id="T70:U399"><span class="var type1" id="S49T70U530">YKAUG</span>.*<span class="mxinfo" id="T70:U401">repmat(<span class="mxinfo" id="T76:U402"><span class="var type1" id="S43T69U534">wm</span>'</span>,<span class="var type1" id="S51T3U535">g</span>,1)</span></span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="comment">% add something to handle magnetometer normalization if necessary here</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">% measurement covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="mxinfo" id="T12:U405"><span class="var type1" id="S53T12U540">Pyk</span> = <span class="mxinfo" id="T12:U407">zeros(<span class="var type1" id="S51T3U543">g</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="comment">% cross covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="mxinfo" id="T71:U409"><span class="var type1" id="S54T71U546">Pxkyk</span> = <span class="mxinfo" id="T71:U411">zeros(<span class="var type1" id="S11T3U549">n</span>,<span class="var type1" id="S51T3U550">g</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S37T3U553">k</span> = <span class="mxinfo" id="T3:U415">1</span>:<span class="mxinfo" id="T3:U416"><span class="mxinfo" id="T3:U417"><span class="mxinfo" id="T3:U418">2</span>*<span class="var type1" id="S17T3U559">N</span></span>+<span class="mxinfo" id="T3:U420">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo" id="T12:U421"><span class="var type1" id="S53T12U563">Pyk</span> = <span class="mxinfo" id="T12:U423"><span class="var type1" id="S53T12U565">Pyk</span> + <span class="mxinfo" id="T12:U425"><span class="mxinfo" id="T2:U426"><span class="mxinfo" id="T3:U427"><span class="var type1" id="S41T69U569">wc</span>(<span class="var type1" id="S37T3U570">k</span>)</span>*(<span class="mxinfo" id="T2:U430"><span class="mxinfo" id="T2:U431"><span class="var type1" id="S49T70U574">YKAUG</span>(:,<span class="var type1" id="S37T3U576">k</span>)</span>-<span class="var type1" id="S52T2U577">yhat</span></span>)</span>*<span class="mxinfo" id="T18:U435">(<span class="mxinfo" id="T2:U436"><span class="mxinfo" id="T2:U437"><span class="var type1" id="S49T70U582">YKAUG</span>(:,<span class="var type1" id="S37T3U584">k</span>)</span>-<span class="var type1" id="S52T2U585">yhat</span></span>)'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="mxinfo" id="T71:U441"><span class="var type1" id="S54T71U588">Pxkyk</span> = <span class="mxinfo" id="T71:U443"><span class="var type1" id="S54T71U590">Pxkyk</span> + <span class="mxinfo" id="T12:U445"><span class="mxinfo" id="T2:U446"><span class="mxinfo" id="T3:U447"><span class="var type1" id="S41T69U594">wc</span>(<span class="var type1" id="S37T3U595">k</span>)</span>*(<span class="mxinfo" id="T1:U450"><span class="mxinfo" id="T1:U451"><span class="var type1" id="S38T68U599">XAUGPLUS</span>(<span class="mxinfo" id="T9:U453"><span class="mxinfo" id="T3:U454">1</span>:<span class="var type1" id="S11T3U602">n</span></span>,<span class="var type1" id="S37T3U603">k</span>)</span>-<span class="var type1" id="S44T1U604">xp</span></span>)</span>*<span class="mxinfo" id="T18:U458">(<span class="mxinfo" id="T2:U459"><span class="mxinfo" id="T2:U460"><span class="var type1" id="S49T70U609">YKAUG</span>(:,<span class="var type1" id="S37T3U611">k</span>)</span>-<span class="var type1" id="S52T2U612">yhat</span></span>)'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"><span class="comment">% Kalman gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T9:U464">any(<span class="mxinfo" id="T60:U465">any(<span class="mxinfo" id="T59:U466">isnan(<span class="var type1" id="S53T12U621">Pyk</span>)</span>)</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">    <span class="mxinfo" id="T40:U468"><span class="autoExtrinsicFcn" id="F772N4:B624">disp</span>(<span class="mxinfo" id="T85:U469"><span class="string">'Singular measurement covariance'</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">    <span class="mxinfo" id="T1:U470"><span class="var type1" id="S2T1U628">xnew</span> = <span class="mxinfo" id="T3:U472">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">    <span class="mxinfo" id="T5:U473"><span class="var type1" id="S3T5U632">Pnew</span> = <span class="mxinfo" id="T3:U475">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="mxinfo" id="T71:U476"><span class="var type1" id="S58T71U637">Kk</span> = <span class="mxinfo" id="T71:U478"><span class="var type1" id="S54T71U639">Pxkyk</span>*(<span class="mxinfo" id="T12:U480"><span class="var type1" id="S53T12U642">Pyk</span>\<span class="mxinfo" id="T12:U482">eye(<span class="var type1" id="S51T3U645">g</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="comment">% handle special cases by examining the input function names</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"><span class="comment">% minimize angle difference</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"><span class="comment">%minimize diff between bearing/declination angles to agents</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="mxinfo" id="T84:U484"><span class="mxinfo" id="T84:U485"><span class="var type1" id="S52T2U649">yhat</span>(<span class="mxinfo" id="T84:U487">[<span class="mxinfo" id="T3:U488">2</span> <span class="mxinfo" id="T3:U489">3</span> <span class="mxinfo" id="T3:U490">5</span> <span class="mxinfo" id="T3:U491">6</span>]</span>)</span> = <span class="mxinfo" id="T43:U492"><span class="fcn" id="F554N9:B657">minangle</span>(<span class="mxinfo" id="T43:U493"><span class="var type1" id="S52T2U659">yhat</span>(<span class="mxinfo" id="T84:U495">[<span class="mxinfo" id="T3:U496">2</span> <span class="mxinfo" id="T3:U497">3</span> <span class="mxinfo" id="T3:U498">5</span> <span class="mxinfo" id="T3:U499">6</span>]</span>)</span>,<span class="mxinfo" id="T43:U500"><span class="var type1" id="S9T1U667">ytilde</span>(<span class="mxinfo" id="T84:U502">[<span class="mxinfo" id="T3:U503">2</span> <span class="mxinfo" id="T3:U504">3</span> <span class="mxinfo" id="T3:U505">5</span> <span class="mxinfo" id="T3:U506">6</span>]</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="comment">% normalize magnetometer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="mxinfo" id="T49:U507"><span class="mxinfo" id="T49:U508"><span class="var type1" id="S52T2U677">yhat</span>(<span class="mxinfo" id="T49:U510"><span class="mxinfo" id="T3:U511">7</span>:<span class="mxinfo" id="T3:U512">9</span></span>)</span> = <span class="mxinfo" id="T33:U513"><span class="mxinfo" id="T33:U514"><span class="var type1" id="S52T2U683">yhat</span>(<span class="mxinfo" id="T49:U516"><span class="mxinfo" id="T3:U517">7</span>:<span class="mxinfo" id="T3:U518">9</span></span>)</span>./<span class="mxinfo" id="T3:U519">norm(<span class="mxinfo" id="T33:U520"><span class="var type1" id="S52T2U690">yhat</span>(<span class="mxinfo" id="T49:U522"><span class="mxinfo" id="T3:U523">7</span>:<span class="mxinfo" id="T3:U524">9</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"><span class="comment">% minimize diff between bearing/declination to features</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="mxinfo" id="T3:U525"><span class="var type1" id="S18T3U696">m1</span> = <span class="mxinfo" id="T3:U527"><span class="var type1" id="S8T4U698">uk</span>(<span class="mxinfo" id="T3:U529">10</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="mxinfo" id="T3:U530"><span class="var type1" id="S19T3U702">m2</span> = <span class="mxinfo" id="T3:U532"><span class="var type1" id="S8T4U704">uk</span>(<span class="mxinfo" id="T3:U534"><span class="mxinfo" id="T3:U535"><span class="mxinfo" id="T3:U536">10</span> + <span class="mxinfo" id="T3:U537"><span class="mxinfo" id="T3:U538">3</span>*<span class="var type1" id="S18T3U710">m1</span></span></span> + <span class="mxinfo" id="T3:U540">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="mxinfo" id="T18:U541"><span class="mxinfo" id="T18:U542"><span class="var type1" id="S52T2U715">yhat</span>( <span class="mxinfo" id="T18:U544">(<span class="mxinfo" id="T18:U545">2:3:(<span class="mxinfo" id="T3:U546"><span class="mxinfo" id="T3:U547">3</span>*<span class="var type1" id="S18T3U725">m1</span></span>)</span>) + <span class="mxinfo" id="T3:U549">9</span></span>)</span> = <span class="mxinfo" id="T2:U550"><span class="fcn" id="F582N9:B728">minangle</span>(<span class="mxinfo" id="T2:U551"><span class="var type1" id="S52T2U730">yhat</span>( <span class="mxinfo" id="T18:U553">(<span class="mxinfo" id="T18:U554">2:3:(<span class="mxinfo" id="T3:U555"><span class="mxinfo" id="T3:U556">3</span>*<span class="var type1" id="S18T3U740">m1</span></span>)</span>) + <span class="mxinfo" id="T3:U558">9</span></span>)</span>,<span class="mxinfo" id="T2:U559"><span class="var type1" id="S9T1U743">ytilde</span>( <span class="mxinfo" id="T18:U561">(<span class="mxinfo" id="T18:U562">2:3:(<span class="mxinfo" id="T3:U563"><span class="mxinfo" id="T3:U564">3</span>*<span class="var type1" id="S18T3U753">m1</span></span>)</span>) + <span class="mxinfo" id="T3:U566">9</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="mxinfo" id="T18:U567"><span class="mxinfo" id="T18:U568"><span class="var type1" id="S52T2U758">yhat</span>( <span class="mxinfo" id="T18:U570">(<span class="mxinfo" id="T18:U571">3:3:(<span class="mxinfo" id="T3:U572"><span class="mxinfo" id="T3:U573">3</span>*<span class="var type1" id="S18T3U768">m1</span></span>)</span>) + <span class="mxinfo" id="T3:U575">9</span></span>)</span> = <span class="mxinfo" id="T2:U576"><span class="fcn" id="F582N9:B771">minangle</span>(<span class="mxinfo" id="T2:U577"><span class="var type1" id="S52T2U773">yhat</span>( <span class="mxinfo" id="T18:U579">(<span class="mxinfo" id="T18:U580">3:3:(<span class="mxinfo" id="T3:U581"><span class="mxinfo" id="T3:U582">3</span>*<span class="var type1" id="S18T3U783">m1</span></span>)</span>) + <span class="mxinfo" id="T3:U584">9</span></span>)</span>,<span class="mxinfo" id="T2:U585"><span class="var type1" id="S9T1U786">ytilde</span>( <span class="mxinfo" id="T18:U587">(<span class="mxinfo" id="T18:U588">3:3:(<span class="mxinfo" id="T3:U589"><span class="mxinfo" id="T3:U590">3</span>*<span class="var type1" id="S18T3U796">m1</span></span>)</span>) + <span class="mxinfo" id="T3:U592">9</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="mxinfo" id="T18:U593"><span class="mxinfo" id="T18:U594"><span class="var type1" id="S52T2U801">yhat</span>( <span class="mxinfo" id="T18:U596"><span class="mxinfo" id="T3:U597"><span class="mxinfo" id="T3:U598">9</span> + <span class="mxinfo" id="T3:U599"><span class="mxinfo" id="T3:U600">3</span>*<span class="var type1" id="S18T3U807">m1</span></span></span> + (<span class="mxinfo" id="T18:U602">2:3:<span class="mxinfo" id="T3:U603"><span class="mxinfo" id="T3:U604">3</span>*<span class="var type1" id="S19T3U815">m2</span></span></span>)</span> )</span> = <span class="mxinfo" id="T2:U606"><span class="fcn" id="F582N9:B817">minangle</span>(<span class="mxinfo" id="T2:U607"><span class="var type1" id="S52T2U819">yhat</span>( <span class="mxinfo" id="T18:U609"><span class="mxinfo" id="T3:U610"><span class="mxinfo" id="T3:U611">9</span> + <span class="mxinfo" id="T3:U612"><span class="mxinfo" id="T3:U613">3</span>*<span class="var type1" id="S18T3U825">m1</span></span></span> + (<span class="mxinfo" id="T18:U615">2:3:<span class="mxinfo" id="T3:U616"><span class="mxinfo" id="T3:U617">3</span>*<span class="var type1" id="S19T3U833">m2</span></span></span>)</span> )</span>,<span class="mxinfo" id="T2:U619"><span class="var type1" id="S9T1U835">ytilde</span>( <span class="mxinfo" id="T18:U621"><span class="mxinfo" id="T3:U622"><span class="mxinfo" id="T3:U623">9</span> + <span class="mxinfo" id="T3:U624"><span class="mxinfo" id="T3:U625">3</span>*<span class="var type1" id="S18T3U841">m1</span></span></span> + (<span class="mxinfo" id="T18:U627">2:3:<span class="mxinfo" id="T3:U628"><span class="mxinfo" id="T3:U629">3</span>*<span class="var type1" id="S19T3U849">m2</span></span></span>)</span> )</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="mxinfo" id="T18:U631"><span class="mxinfo" id="T18:U632"><span class="var type1" id="S52T2U853">yhat</span>( <span class="mxinfo" id="T18:U634"><span class="mxinfo" id="T3:U635"><span class="mxinfo" id="T3:U636">9</span> + <span class="mxinfo" id="T3:U637"><span class="mxinfo" id="T3:U638">3</span>*<span class="var type1" id="S18T3U859">m1</span></span></span> + (<span class="mxinfo" id="T18:U640">3:3:<span class="mxinfo" id="T3:U641"><span class="mxinfo" id="T3:U642">3</span>*<span class="var type1" id="S19T3U867">m2</span></span></span>)</span> )</span> = <span class="mxinfo" id="T2:U644"><span class="fcn" id="F582N9:B869">minangle</span>(<span class="mxinfo" id="T2:U645"><span class="var type1" id="S52T2U871">yhat</span>( <span class="mxinfo" id="T18:U647"><span class="mxinfo" id="T3:U648"><span class="mxinfo" id="T3:U649">9</span> + <span class="mxinfo" id="T3:U650"><span class="mxinfo" id="T3:U651">3</span>*<span class="var type1" id="S18T3U877">m1</span></span></span> + (<span class="mxinfo" id="T18:U653">3:3:<span class="mxinfo" id="T3:U654"><span class="mxinfo" id="T3:U655">3</span>*<span class="var type1" id="S19T3U885">m2</span></span></span>)</span> )</span>,<span class="mxinfo" id="T2:U657"><span class="var type1" id="S9T1U887">ytilde</span>( <span class="mxinfo" id="T18:U659"><span class="mxinfo" id="T3:U660"><span class="mxinfo" id="T3:U661">9</span> + <span class="mxinfo" id="T3:U662"><span class="mxinfo" id="T3:U663">3</span>*<span class="var type1" id="S18T3U893">m1</span></span></span> + (<span class="mxinfo" id="T18:U665">3:3:<span class="mxinfo" id="T3:U666"><span class="mxinfo" id="T3:U667">3</span>*<span class="var type1" id="S19T3U901">m2</span></span></span>)</span> )</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="mxinfo" id="T18:U669"><span class="mxinfo" id="T18:U670"><span class="var type1" id="S52T2U905">yhat</span>( <span class="mxinfo" id="T18:U672"><span class="mxinfo" id="T3:U673"><span class="mxinfo" id="T3:U674">9</span> + <span class="mxinfo" id="T3:U675"><span class="mxinfo" id="T3:U676">3</span>*(<span class="mxinfo" id="T3:U677"><span class="var type1" id="S18T3U913">m1</span>+<span class="var type1" id="S19T3U914">m2</span></span>)</span></span> + (<span class="mxinfo" id="T18:U680">2:3:<span class="mxinfo" id="T3:U681"><span class="mxinfo" id="T3:U682">3</span>*<span class="var type1" id="S20T3U922">w1</span></span></span>)</span> )</span> = <span class="mxinfo" id="T2:U684"><span class="fcn" id="F582N9:B924">minangle</span>(<span class="mxinfo" id="T2:U685"><span class="var type1" id="S52T2U926">yhat</span>( <span class="mxinfo" id="T18:U687"><span class="mxinfo" id="T3:U688"><span class="mxinfo" id="T3:U689">9</span> + <span class="mxinfo" id="T3:U690"><span class="mxinfo" id="T3:U691">3</span>*(<span class="mxinfo" id="T3:U692"><span class="var type1" id="S18T3U934">m1</span>+<span class="var type1" id="S19T3U935">m2</span></span>)</span></span> + (<span class="mxinfo" id="T18:U695">2:3:<span class="mxinfo" id="T3:U696"><span class="mxinfo" id="T3:U697">3</span>*<span class="var type1" id="S20T3U943">w1</span></span></span>)</span> )</span>,<span class="mxinfo" id="T2:U699"><span class="var type1" id="S9T1U945">ytilde</span>( <span class="mxinfo" id="T18:U701"><span class="mxinfo" id="T3:U702"><span class="mxinfo" id="T3:U703">9</span> + <span class="mxinfo" id="T3:U704"><span class="mxinfo" id="T3:U705">3</span>*(<span class="mxinfo" id="T3:U706"><span class="var type1" id="S18T3U953">m1</span>+<span class="var type1" id="S19T3U954">m2</span></span>)</span></span> + (<span class="mxinfo" id="T18:U709">2:3:<span class="mxinfo" id="T3:U710"><span class="mxinfo" id="T3:U711">3</span>*<span class="var type1" id="S20T3U962">w1</span></span></span>)</span> )</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="mxinfo" id="T18:U713"><span class="mxinfo" id="T18:U714"><span class="var type1" id="S52T2U966">yhat</span>( <span class="mxinfo" id="T18:U716"><span class="mxinfo" id="T3:U717"><span class="mxinfo" id="T3:U718">9</span> + <span class="mxinfo" id="T3:U719"><span class="mxinfo" id="T3:U720">3</span>*(<span class="mxinfo" id="T3:U721"><span class="var type1" id="S18T3U974">m1</span>+<span class="var type1" id="S19T3U975">m2</span></span>)</span></span> + (<span class="mxinfo" id="T18:U724">3:3:<span class="mxinfo" id="T3:U725"><span class="mxinfo" id="T3:U726">3</span>*<span class="var type1" id="S20T3U983">w1</span></span></span>)</span> )</span> = <span class="mxinfo" id="T2:U728"><span class="fcn" id="F582N9:B985">minangle</span>(<span class="mxinfo" id="T2:U729"><span class="var type1" id="S52T2U987">yhat</span>( <span class="mxinfo" id="T18:U731"><span class="mxinfo" id="T3:U732"><span class="mxinfo" id="T3:U733">9</span> + <span class="mxinfo" id="T3:U734"><span class="mxinfo" id="T3:U735">3</span>*(<span class="mxinfo" id="T3:U736"><span class="var type1" id="S18T3U995">m1</span>+<span class="var type1" id="S19T3U996">m2</span></span>)</span></span> + (<span class="mxinfo" id="T18:U739">3:3:<span class="mxinfo" id="T3:U740"><span class="mxinfo" id="T3:U741">3</span>*<span class="var type1" id="S20T3U1004">w1</span></span></span>)</span> )</span>,<span class="mxinfo" id="T2:U743"><span class="var type1" id="S9T1U1006">ytilde</span>( <span class="mxinfo" id="T18:U745"><span class="mxinfo" id="T3:U746"><span class="mxinfo" id="T3:U747">9</span> + <span class="mxinfo" id="T3:U748"><span class="mxinfo" id="T3:U749">3</span>*(<span class="mxinfo" id="T3:U750"><span class="var type1" id="S18T3U1014">m1</span>+<span class="var type1" id="S19T3U1015">m2</span></span>)</span></span> + (<span class="mxinfo" id="T18:U753">3:3:<span class="mxinfo" id="T3:U754"><span class="mxinfo" id="T3:U755">3</span>*<span class="var type1" id="S20T3U1023">w1</span></span></span>)</span> )</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"><span class="mxinfo" id="T1:U757"><span class="var type1" id="S61T1U1026">xn</span> = <span class="mxinfo" id="T1:U759"><span class="var type1" id="S44T1U1028">xp</span> + <span class="mxinfo" id="T1:U761"><span class="var type1" id="S58T71U1030">Kk</span>*(<span class="mxinfo" id="T1:U763"><span class="var type1" id="S9T1U1033">ytilde</span>-<span class="var type1" id="S52T2U1034">yhat</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="comment">% renormalize quaternions as necessary</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="mxinfo" id="T84:U766"><span class="mxinfo" id="T84:U767"><span class="var type1" id="S61T1U1038">xn</span>(<span class="mxinfo" id="T84:U769"><span class="mxinfo" id="T3:U770">7</span>:<span class="mxinfo" id="T3:U771">10</span></span>)</span> = <span class="mxinfo" id="T43:U772"><span class="mxinfo" id="T43:U773"><span class="var type1" id="S61T1U1044">xn</span>(<span class="mxinfo" id="T84:U775"><span class="mxinfo" id="T3:U776">7</span>:<span class="mxinfo" id="T3:U777">10</span></span>)</span>/<span class="mxinfo" id="T3:U778">norm(<span class="mxinfo" id="T43:U779"><span class="var type1" id="S61T1U1051">xn</span>(<span class="mxinfo" id="T84:U781"><span class="mxinfo" id="T3:U782">7</span>:<span class="mxinfo" id="T3:U783">10</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"><span class="mxinfo" id="T84:U784"><span class="mxinfo" id="T84:U785"><span class="var type1" id="S61T1U1058">xn</span>(<span class="mxinfo" id="T84:U787"><span class="mxinfo" id="T3:U788">14</span>:<span class="mxinfo" id="T3:U789">17</span></span>)</span> = <span class="mxinfo" id="T43:U790"><span class="mxinfo" id="T43:U791"><span class="var type1" id="S61T1U1064">xn</span>(<span class="mxinfo" id="T84:U793"><span class="mxinfo" id="T3:U794">14</span>:<span class="mxinfo" id="T3:U795">17</span></span>)</span>/<span class="mxinfo" id="T3:U796">norm(<span class="mxinfo" id="T43:U797"><span class="var type1" id="S61T1U1071">xn</span>(<span class="mxinfo" id="T84:U799"><span class="mxinfo" id="T3:U800">14</span>:<span class="mxinfo" id="T3:U801">17</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="mxinfo" id="T1:U802"><span class="var type1" id="S2T1U1077">xnew</span> = <span class="var type1" id="S61T1U1078">xn</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"><span class="mxinfo" id="T5:U805"><span class="var type1" id="S3T5U1081">Pnew</span> = <span class="mxinfo" id="T5:U807"><span class="var type1" id="S48T5U1083">Pp</span> - <span class="mxinfo" id="T71:U809"><span class="mxinfo" id="T71:U810"><span class="var type1" id="S58T71U1086">Kk</span>*<span class="var type1" id="S53T12U1087">Pyk</span></span>*<span class="mxinfo" id="T86:U813"><span class="var type1" id="S58T71U1089">Kk</span>'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
